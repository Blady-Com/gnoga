#  -*- coding: utf-8 -*-
#
#  ZanyBlue, an Ada library and framework for finite element analysis.
#
#  Copyright (c) 2012, 2016, Michael Rohan <mrohan@zanyblue.com>
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#
#    * Redistributions of source code must retain the above copyright
#      notice, this list of conditions and the following disclaimer.
#
#    * Redistributions in binary form must reproduce the above copyright
#      notice, this list of conditions and the following disclaimer in the
#      documentation and/or other materials provided with the distribution.
#
#    * Neither the name of ZanyBlue nor the names of its contributors may
#      be used to endorse or promote products derived from this software
#      without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
#  TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
#  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
#  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
#  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
#  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# This Makefile is based on the the Makefile generated by the Sphinx
# documentation system.
#

TOP=../..

SPHINXOPTS    += -D release="$(VERSION)"
SPHINXOPTS    += -D version="$(V_MAJOR).$(V_MINOR)"
SPHINXBUILD   = sphinx-build
DOCLINKSRST   = $(SRCDIR)/doc/source/links.rst
PAPER         =
BUILDDIR      = build
PAPEROPT_a4     = -D latex_paper_size=a4
PAPEROPT_letter = -D latex_paper_size=letter
VERSION_sphinx  = -D version=$(VERSION)
ALLSPHINXOPTS   = -d $(BUILDDIR)/doctrees $(PAPEROPT_$(PAPER)) $(SPHINXOPTS) source
# the i18n builder cannot share the environment and doctrees with the others
I18NSPHINXOPTS  = $(PAPEROPT_$(PAPER)) $(SPHINXOPTS) source

SRCPDF=$(SRCDIR)/doc/build/latex/ZanyBlue.pdf
DSTPDF=$(DOCDIR)/ZanyBlue.pdf

CLEAN_FILES+=$(wildcard gnatcheck-source-list.out)
CLEAN_FILES+=$(wildcard source/notices.rst)
CLEAN_FILES+=$(wildcard source/contribs.rst)
CLEAN_FILES+=$(wildcard $(DOCLINKSRST))
CLEAN_DIRS+=$(BUILDDIR)
CLEAN_DIRS+=$(wildcard source/zbtest/function)
CLEAN_DIRS+=$(wildcard source/zbtest/command)
DEV_CLEAN_FILES+=$(wildcard $(TOP)/CONTRIBUTIONS.txt)
DEV_CLEAN_FILES+=$(wildcard $(TOP)/NOTICES.txt)

# Include configuration definitions
include $(TOP)/src/mkfile/conf.mk

# User-friendly check for sphinx-build
ifeq ($(shell which $(SPHINXBUILD) >/dev/null 2>&1; echo $$?), 1)
	$(error The '$(SPHINXBUILD)' command was not found. Make sure you have Sphinx installed, then set the SPHINXBUILD environment variable to point to the full path of the '$(SPHINXBUILD)' executable. Alternatively you can add the directory with the executable to your PATH. If you don\'t have Sphinx installed, grab it from http://sphinx-doc.org/)
endif

all:	html latexpdf gnatdocs
	$(call COPY,$(SRCPDF),$(DSTPDF))

html:	acknowlegments source/zbtest/function source/zbtest/command $(DOCLINKSRST)
	$(SPHINXBUILD) -b html $(ALLSPHINXOPTS) ../../doc

source/zbtest/function source/zbtest/command:	$(wildcard ../zbtest/commands/*.adb) $(wildcard ../zbtest/functions/*.adb)
	$(ZBDEV) mkzbtestdoc -D

gnatdocs:
	$(GNATDOC) -P$(SRCDIR)/zanyblue

acknowlegments:
	$(ZBDEV) mknotices

$(DOCLINKSRST):
	echo ".. _download: $(DOWNLOAD_URL)" > $(DOCLINKSRST)

latexpdf:
	$(SPHINXBUILD) -b latex $(ALLSPHINXOPTS) $(BUILDDIR)/latex
	@echo "Running LaTeX files through pdflatex..."
	$(MAKE) -C $(BUILDDIR)/latex all-pdf
	@echo "pdflatex finished; the PDF files are in $(BUILDDIR)/latex."

# Include general rules.
include $(TOP)/src/mkfile/rules.mk

# The following additional Sphinx generated targets are not used by ZanyBlue
#
# dirhtml:
# 	$(SPHINXBUILD) -b dirhtml $(ALLSPHINXOPTS) $(BUILDDIR)/dirhtml
# 	@echo
# 	@echo "Build finished. The HTML pages are in $(BUILDDIR)/dirhtml."
#
# singlehtml:
# 	$(SPHINXBUILD) -b singlehtml $(ALLSPHINXOPTS) $(BUILDDIR)/singlehtml
# 	@echo
# 	@echo "Build finished. The HTML page is in $(BUILDDIR)/singlehtml."
#
# pickle:
# 	$(SPHINXBUILD) -b pickle $(ALLSPHINXOPTS) $(BUILDDIR)/pickle
# 	@echo
# 	@echo "Build finished; now you can process the pickle files."
#
# json:
# 	$(SPHINXBUILD) -b json $(ALLSPHINXOPTS) $(BUILDDIR)/json
# 	@echo
# 	@echo "Build finished; now you can process the JSON files."
#
# htmlhelp:
# 	$(SPHINXBUILD) -b htmlhelp $(ALLSPHINXOPTS) $(BUILDDIR)/htmlhelp
# 	@echo
# 	@echo "Build finished; now you can run HTML Help Workshop with the" \
# 	      ".hhp project file in $(BUILDDIR)/htmlhelp."
#
# qthelp:
# 	$(SPHINXBUILD) -b qthelp $(ALLSPHINXOPTS) $(BUILDDIR)/qthelp
# 	@echo
# 	@echo "Build finished; now you can run "qcollectiongenerator" with the" \
# 	      ".qhcp project file in $(BUILDDIR)/qthelp, like this:"
# 	@echo "# qcollectiongenerator $(BUILDDIR)/qthelp/ZanyBlue.qhcp"
# 	@echo "To view the help file:"
# 	@echo "# assistant -collectionFile $(BUILDDIR)/qthelp/ZanyBlue.qhc"
#
# applehelp:
# 	$(SPHINXBUILD) -b applehelp $(ALLSPHINXOPTS) $(BUILDDIR)/applehelp
# 	@echo
# 	@echo "Build finished. The help book is in $(BUILDDIR)/applehelp."
# 	@echo "N.B. You won't be able to view it unless you put it in" \
# 	      "~/Library/Documentation/Help or install it in your application" \
# 	      "bundle."
#
# devhelp:
# 	$(SPHINXBUILD) -b devhelp $(ALLSPHINXOPTS) $(BUILDDIR)/devhelp
# 	@echo
# 	@echo "Build finished."
# 	@echo "To view the help file:"
# 	@echo "# mkdir -p $$HOME/.local/share/devhelp/ZanyBlue"
# 	@echo "# ln -s $(BUILDDIR)/devhelp $$HOME/.local/share/devhelp/ZanyBlue"
# 	@echo "# devhelp"
#
# epub:
# 	$(SPHINXBUILD) -b epub $(ALLSPHINXOPTS) $(BUILDDIR)/epub
# 	@echo
# 	@echo "Build finished. The epub file is in $(BUILDDIR)/epub."
#
# epub3:
# 	$(SPHINXBUILD) -b epub3 $(ALLSPHINXOPTS) $(BUILDDIR)/epub3
# 	@echo
# 	@echo "Build finished. The epub3 file is in $(BUILDDIR)/epub3."
#
# latex:
# 	$(SPHINXBUILD) -b latex $(ALLSPHINXOPTS) $(BUILDDIR)/latex
# 	@echo
# 	@echo "Build finished; the LaTeX files are in $(BUILDDIR)/latex."
# 	@echo "Run \`make' in that directory to run these through (pdf)latex" \
# 	      "(use \`make latexpdf' here to do that automatically)."
#
# latexpdfja:
# 	$(SPHINXBUILD) -b latex $(ALLSPHINXOPTS) $(BUILDDIR)/latex
# 	@echo "Running LaTeX files through platex and dvipdfmx..."
# 	$(MAKE) -C $(BUILDDIR)/latex all-pdf-ja
# 	@echo "pdflatex finished; the PDF files are in $(BUILDDIR)/latex."
#
# text:
# 	$(SPHINXBUILD) -b text $(ALLSPHINXOPTS) $(BUILDDIR)/text
# 	@echo
# 	@echo "Build finished. The text files are in $(BUILDDIR)/text."
#
# man:
# 	$(SPHINXBUILD) -b man $(ALLSPHINXOPTS) $(BUILDDIR)/man
# 	@echo
# 	@echo "Build finished. The manual pages are in $(BUILDDIR)/man."
#
# texinfo:
# 	$(SPHINXBUILD) -b texinfo $(ALLSPHINXOPTS) $(BUILDDIR)/texinfo
# 	@echo
# 	@echo "Build finished. The Texinfo files are in $(BUILDDIR)/texinfo."
# 	@echo "Run \`make' in that directory to run these through makeinfo" \
# 	      "(use \`make info' here to do that automatically)."
#
# info:
# 	$(SPHINXBUILD) -b texinfo $(ALLSPHINXOPTS) $(BUILDDIR)/texinfo
# 	@echo "Running Texinfo files through makeinfo..."
# 	make -C $(BUILDDIR)/texinfo info
# 	@echo "makeinfo finished; the Info files are in $(BUILDDIR)/texinfo."
#
# gettext:
# 	$(SPHINXBUILD) -b gettext $(I18NSPHINXOPTS) $(BUILDDIR)/locale
# 	@echo
# 	@echo "Build finished. The message catalogs are in $(BUILDDIR)/locale."
#
# changes:
# 	$(SPHINXBUILD) -b changes $(ALLSPHINXOPTS) $(BUILDDIR)/changes
# 	@echo
# 	@echo "The overview file is in $(BUILDDIR)/changes."
#
# linkcheck:
# 	$(SPHINXBUILD) -b linkcheck $(ALLSPHINXOPTS) $(BUILDDIR)/linkcheck
# 	@echo
# 	@echo "Link check complete; look for any errors in the above output " \
# 	      "or in $(BUILDDIR)/linkcheck/output.txt."
#
# doctest:
# 	$(SPHINXBUILD) -b doctest $(ALLSPHINXOPTS) $(BUILDDIR)/doctest
# 	@echo "Testing of doctests in the sources finished, look at the " \
# 	      "results in $(BUILDDIR)/doctest/output.txt."
#
# coverage:
# 	$(SPHINXBUILD) -b coverage $(ALLSPHINXOPTS) $(BUILDDIR)/coverage
# 	@echo "Testing of coverage in the sources finished, look at the " \
# 	      "results in $(BUILDDIR)/coverage/python.txt."
#
# xml:
# 	$(SPHINXBUILD) -b xml $(ALLSPHINXOPTS) $(BUILDDIR)/xml
# 	@echo
# 	@echo "Build finished. The XML files are in $(BUILDDIR)/xml."
#
# pseudoxml:
# 	$(SPHINXBUILD) -b pseudoxml $(ALLSPHINXOPTS) $(BUILDDIR)/pseudoxml
# 	@echo
# 	@echo "Build finished. The pseudo-XML files are in $(BUILDDIR)/pseudoxml."
